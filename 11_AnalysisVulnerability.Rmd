---
title: "11_AnalysisVulnerability"
author: "Adela Sobotkova"
date: "28 July 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Vulnerability

## Methodology
We applied an ordered logit model to determine the vulnerability of burial mounds to anthropogenic threats in the Yambol province. This model has been developed by the authors in a previous study of the Kazanlak Valley in central Bulgaria. However, as the study areas differ in their location, environment, as well as level of development, we expected differences in mound vulnerability and predicted decline. While field observations underscored looting as a massive factor, subjectively looting felt less intense than in Kazanlak (Eftimoski et al. 2017). Agricultural and military activity competed for place among the principal factors contributing to the ubiquitous degradation of the mounds we saw during archaeological surveys (Sobotkova and Weissova 2020). Choosing these factors over others constituted a ‘perceptive’ initial risk assessment (Vojinovic et al. 2016). 

Based on this intuition, we proposed three hypotheses:
- The ploughing, harrowing, and removal of obstacles from fields associated with annual agriculture damage mounds, so conversion of any other land-use type to annual agriculture would tend to damage mounds.
- Proximity to national border formerly the cold-war border
- Proximity to a city, town, or village would contribute to damage, since it is a proxy for destructive peri-urban activities like construction and casual looting (cf. Agapiou et al. 2015).
- Looters would preferentially target larger mounds, since they typically contain richer burials than small ones. We conceded that small mounds are more susceptible to agricultural damage, but thought that damage to large mounds from looting would prove more significant (cf. Stone 2008, 67-68).
The analysis performed here tests our subjective perceptions of risk. We use a large number of observations to model relationships between mound condition and elevation, mound size, surrounding land use (including annual agriculture, perennial agriculture, pasture, or forest), and distance to the nearest urban boundary. 
Five specific changes were then simulated:
- conversion of all forest to annual agriculture;
- conversion of all forest to pasture;
- conversion of all pasture to annual agriculture;
- an increase in distance of one standard deviation (XXX m) from the nearest edge of a city, town, or village.
- an increase in distance of one standard deviation (XXX m) from the southern border / southern aspect / location in 30m border zone?
Finally, relationships between inherent characteristics of the mounds like elevation and height were included, to test our third hypothesis and contextualise results of other analyses.


## Landuse

‘Land-use’ represents how land was used around the mound at the time of survey with categorical values of pasture, forest, annual agriculture (arable land), perennial agriculture, scrub, and urban (Fig. 4). Mounds were most frequent in agricultural fields, which [comprised XXX% of the survey area (XX ha), and ] contained 54.2% of the mounds (640). Conversely, grasslands - whether pastures or overgrown field-divisions - [comprised YYY% of the area ( YYYY ha), but] contained 30.4% of the mounds (359). Scrub surrounded 8.6% mounds (101) , while all the remaining landuse categories together contained the remaining 6.5% of mounds (80). 

Qualify! [Put another way, the density of mounds per sq km was high in pasture, but low in annual agriculture (26.9 vs 2.3 respectively). Any change from pasture to annual agriculture, therefore, may affect a large number of mounds. Scrub and Perennial agriculture were retained in the model to improve estimation of logit coefficients (see 2.3 below), but no attempt was made to simulate land-use transitions on such a small number of mounds (n=99 and 15 respectively). The remaining types of Forest (n=52), and Other (n = 11) can be grouped under ‘Other’ in Fig. 4) due to their low incidence (less than 15% of all mounds altogether).


```{r, echo = FALSE}
library(tidyverse)
```

```{r}
master %>% 
  group_by(LU_Around) %>% 
  tally() %>% 
  mutate(perc = round(n/sum(n)*100, 2))

```

```{r}
master %>% 
  group_by(LU_Top) %>% 
  tally() %>% 
  mutate(perc = round(n/sum(n)*100, 2))
```
Let's check the condition of mounds depending on landuse. 
Get the package (uncomment if running for the first time)
```{r}
#install.packages("ordinal")
```

```{r}
require(ordinal)
```
Lets make each landuse category intoa variable with pivot_Wide

```{r}
master <- master %>% 
  mutate(n=1) %>% 
  pivot_wider(names_from = LU_Around, values_from= n, values_fill = list(n = 0)) %>% 
  rename(Annual = 'Annual agriculture', Perennial = 'Perennial agriculture', OtherLU = Other)

```


Lets now create an effect column on the basis of Condition and convert to a factor to feed it into the model
```{r}
master <- master %>%
  mutate(effect = str_extract(Condition, "[0-9]"))

levels(as.factor(master$effect))
master %>%
  filter(effect == 0) %>% # 90 features have 0 - No observation in Condition
  group_by(Type) %>% 
  tally()
```

Lets review these features where effect/condition is marked as 0 - No observation possible. Are these typos or truly NAs? Well, they do look like NAs, so lets' exclude them in the future. We might also want to focus on mounds only
```{r}
master %>%
  filter(effect == 0 & Type == "Burial Mound")
```
Mound 9548 should have effect == 6, given the pasture landuse. All others should stay as NAs
```{r}
master %>%
  filter(effect == 0) %>% 
  filter(Type == "Extinct Burial Mound" | Type == "Uncertain Mound")
```
All but 9626 should have effect == 6


# Prep data for Logit >> 

- select only mounds
- collate effect into 2-3 categories

```{r}
mounds <- master %>% 
  mutate(effect = case_when(effect == "1" ~ "2",
                     effect == "6" ~ "5",
                     effect %nin% c("1","6") ~ effect)) %>% 
  filter(grepl("Mound", Type))

mounds %>% 
  filter(effect != 0) %>% 
  group_by(effect) %>% 
  tally()
```



Logit model
```{r}
library(haven)
library(MASS)
```

Testing polr function in MASS library


Now back to plain glm)
```{r}
test<-glm(as.factor(effect) ~ Annual + Pasture + Forest + Perennial, family= "binomial", data = mounds) 
summary(test)
```


NEXT: 
1) Get distances out of GIS
2) Try polr() function to get data out
```{r}
logittable1 <- polr(Condition ~ elevation + Annual + Pasture + Perennial + Forest + HeightMax, data=master, Hess=TRUE)
```

